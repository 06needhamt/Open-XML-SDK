variables:
  SdkSolution: 'Open-XML-SDK.sln'
  BuildPlatform: 'Any CPU'
  BuildConfiguration: 'Release'
  ProjectLoadStyle: 'DevCore21'

jobs:
  - job: Build
    displayName: Build SDK
    pool:
      name: Hosted VS2017
      demands:
      - msbuild
      - visualstudio
      - vstest
    steps:

    - task: VSBuild@1
      displayName: 'Build SDK'
      inputs:
        solution: '$(SdkSolution)'
        msbuildArgs: '/m /t:restore;build /p:ProjectLoadStyle=$(ProjectLoadStyle)'
        platform: '$(BuildPlatform)'
        configuration: '$(BuildConfiguration)'

    # - task: VSTest@2
    #   displayName: 'VsTest - testAssemblies'
    #   inputs:
    #     testAssemblyVer2: |
    #       **\$(BuildConfiguration)\**\*test*.dll
    #       !**\obj\**
    #     runInParallel: true
    #     codeCoverageEnabled: true
    #     otherConsoleOptions: '/Platform:x64'
    #     platform: '$(BuildPlatform)'
    #     configuration: '$(BuildConfiguration)'
    #     diagnosticsEnabled: True

    - task: VSBuild@1
      displayName: 'Pack SDK'
      inputs:
        msbuildArgs: '/t:pack /p:ProjectLoadStyle=$(ProjectLoadStyle) /p:PackageOutputPath=$(Build.ArtifactStagingDirectory)'
        platform: '$(BuildPlatform)'
        configuration: '$(BuildConfiguration)'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Unsigned'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'unsigned'

  - job: Sign
    displayName: Sign assemblies and package
    pool:
      name: Hosted VS2017
    steps:
      - checkout: none
      - task: DownloadBuildArtifacts@0
        displayName: 'Download Build Artifacts'
        inputs:
          artifactName: unsigned
          downloadPath: $(System.DefaultWorkingDirectory)
      - task: ExtractFiles@1
        inputs:
          archiveFilePatterns: 'DocumentFormat.OpenXml.nupkg'
          destinationFolder: '$(System.DefaultWorkingDirectory)/working'
      - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
        displayName: 'OpenXML SDK Assembly ESRP CodeSigning'
        inputs:
          ConnectedServiceName: 'Open-XML-SDK-ESRP'
          FolderPath: '$(build.artifactstagingdirectory)\working'
          Pattern: '**\DocumentFormat.OpenXml.dll'
          UseMinimatch: true
          signConfigType: inlineSignParams
          inlineOperation: |
            [
              {
                "keyCode": "CP-230012",
                "operationSetCode": "SigntoolSign",
                "parameters": [
                  {
                    "parameterName": "OpusName",
                    "parameterValue": "Microsoft"
                  },
                  {
                    "parameterName": "OpusInfo",
                    "parameterValue": "http://www.microsoft.com"
                  },
                  {
                    "parameterName": "PageHash",
                    "parameterValue": "/NPH"
                  },
                  {
                    "parameterName": "FileDigest",
                    "parameterValue": "/fd sha256"
                  },
                  {
                    "parameterName": "TimeStamp",
                    "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  }
                ],
                "toolName": "signtool.exe",
                "toolVersion": "6.2.9304.0"
              }
            ]
      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: '$(System.DefaultWorkingDirectory)/working' 
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/DocumentFormat.OpenXml.nupkg' 
          replaceExistingArchive: true 
          verbose: true
      - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
        displayName: 'OpenXML SDK Nuget Pkg ESRP CodeSigning'
        inputs:
          ConnectedServiceName: 'Open-XML-SDK-ESRP'
          FolderPath: '$(Build.ArtifactStagingDirectory)'
          Pattern: '*.nupkg'
          signConfigType: inlineSignParams
          inlineOperation: |
            [
                {
                    "keyCode": "CP-401405",
                    "operationSetCode": "NuGetSign",
                    "parameters": [ ],
                    "toolName": "sign",
                    "toolVersion": "1.0"
                },
                {
                    "keyCode": "CP-401405",
                    "operationSetCode": "NuGetVerify",
                    "parameters": [ ],
                    "toolName": "sign",
                    "toolVersion": "1.0"
                }
            ]

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Signed'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: 'signed'

    dependsOn: Build
    condition: succeeded()
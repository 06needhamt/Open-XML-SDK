variables:
  SdkSolution: 'Open-XML-SDK.sln'
  BuildPlatform: 'Any CPU'
  BuildConfiguration: 'Release'
  ProjectLoadStyle: 'DevCore21'

trigger:
- master

pr:
  autoCancel: true
  branches:
    include:
    - master

stages:
- stage: Build
  jobs:
    - job: Build
      displayName: Build SDK
      pool:
        name: Hosted VS2017
        demands:
        - msbuild
        - visualstudio
        - vstest
      steps:
        - template: build.yml

    - job: Sign
      displayName: Sign assemblies and package
      pool:
        name: Hosted VS2017
      steps:
        - template: sign.yml
      dependsOn: Build
      condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
- stage: Deploy
  jobs:
  - deployment: MyGet
    environment: ooxmlsdk-myget
    strategy:
      runOnce:
        deploy:
          steps:
            - template: deploy-myget.yml
  - deployment: NuGet
    environment: ooxmlsdk-nuget
    strategy:
      runOnce:
        deploy:
          steps:
            - template: deploy-nuget.yml
    dependsOn: MyGet
    condition: succeeded()
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))